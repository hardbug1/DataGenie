---
globs: **/*.py,**/*.yml,**/*.md,requirements/**/*.txt
description: DataGenie project structure and architecture guidelines
---

# DataGenie Project Structure & Architecture Rules

## ğŸ—ï¸ CRITICAL PROJECT STRUCTURE
You are working on **DataGenie**, an LLM-based data analysis and visualization service built with:
- **Backend**: FastAPI + LangChain + SQLAlchemy
- **Frontend**: Gradio web interface
- **Database**: PostgreSQL (system) + External DBs (PostgreSQL/MySQL/SQLite)
- **Cache**: Redis
- **AI**: OpenAI GPT-4 integration

## ğŸ“ MANDATORY DIRECTORY STRUCTURE (í˜„ì¬ êµ¬í˜„ ìƒíƒœ)
```
datagenie/
â”œâ”€â”€ app/                    # Main application code
â”‚   â”œâ”€â”€ main.py            # FastAPI entry point âœ… êµ¬í˜„ë¨
â”‚   â”œâ”€â”€ config/            # Configuration management âœ… êµ¬í˜„ë¨
â”‚   â”‚   â”œâ”€â”€ settings.py    # í™˜ê²½ ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ database.py    # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
â”‚   â”‚   â””â”€â”€ logging.py     # ë¡œê¹… ì„¤ì • âœ… êµ¬í˜„ë¨
â”‚   â”œâ”€â”€ domain/            # Clean Architecture - Domain ê³„ì¸µ âœ… êµ¬í˜„ë¨
â”‚   â”‚   â”œâ”€â”€ entities/      # ë¹„ì¦ˆë‹ˆìŠ¤ ì—”í‹°í‹°
â”‚   â”‚   â”œâ”€â”€ value_objects/ # ê°’ ê°ì²´
â”‚   â”‚   â””â”€â”€ interfaces/    # ë„ë©”ì¸ ì¸í„°í˜ì´ìŠ¤
â”‚   â”œâ”€â”€ use_cases/         # Clean Architecture - Use Cases ê³„ì¸µ âœ… êµ¬í˜„ë¨
â”‚   â”‚   â””â”€â”€ analysis/      # ë¶„ì„ ìœ ìŠ¤ì¼€ì´ìŠ¤
â”‚   â”œâ”€â”€ infrastructure/    # Clean Architecture - Infrastructure ê³„ì¸µ âœ… êµ¬í˜„ë¨
â”‚   â”‚   â”œâ”€â”€ adapters/      # ì–´ëŒ‘í„° êµ¬í˜„
â”‚   â”‚   â””â”€â”€ di_container.py # ì˜ì¡´ì„± ì£¼ì… ì»¨í…Œì´ë„ˆ
â”‚   â”œâ”€â”€ api/              # API ê³„ì¸µ âœ… êµ¬í˜„ë¨
â”‚   â”‚   â”œâ”€â”€ v1/           # API v1 ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â””â”€â”€ dependencies.py # API ì˜ì¡´ì„±
â”‚   â”œâ”€â”€ schemas/          # Pydantic schemas âœ… êµ¬í˜„ë¨
â”‚   â”‚   â””â”€â”€ analysis.py   # ë¶„ì„ ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ models/           # SQLAlchemy database models âœ… ê¸°ì¡´ êµ¬í˜„
â”‚   â”‚   â”œâ”€â”€ user.py       # ì‚¬ìš©ì ëª¨ë¸
â”‚   â”‚   â””â”€â”€ database_connection.py # DB ì—°ê²° ëª¨ë¸
â”‚   â”œâ”€â”€ core/             # Core business logic (í–¥í›„ êµ¬í˜„)
â”‚   â”‚   â”œâ”€â”€ nlp/          # Natural language processing
â”‚   â”‚   â”œâ”€â”€ query/        # Database query engine
â”‚   â”‚   â”œâ”€â”€ excel/        # Excel analysis engine
â”‚   â”‚   â””â”€â”€ visualization/ # Chart generation
â”‚   â”œâ”€â”€ auth/             # Authentication & authorization (í–¥í›„ êµ¬í˜„)
â”‚   â”œâ”€â”€ cache/            # Redis caching logic (í–¥í›„ êµ¬í˜„)
â”‚   â””â”€â”€ utils/            # Utility functions (í–¥í›„ êµ¬í˜„)
â”œâ”€â”€ docs/                 # Project documentation âœ… ì™„ì„±
â”‚   â”œâ”€â”€ system_architecture.md
â”‚   â”œâ”€â”€ functional_requirements.md
â”‚   â”œâ”€â”€ api_specification.md
â”‚   â”œâ”€â”€ database_design.md
â”‚   â””â”€â”€ development_checklist.md
â”œâ”€â”€ tests/                # Test files (í–¥í›„ êµ¬í˜„)
â”œâ”€â”€ scripts/              # Database migrations & utilities (í–¥í›„ êµ¬í˜„)
â”œâ”€â”€ requirements/         # Dependency management âœ… êµ¬í˜„ë¨
â”‚   â””â”€â”€ base.txt         # ê¸°ë³¸ ì˜ì¡´ì„±
â””â”€â”€ docker/              # Docker configurations âœ… êµ¬í˜„ë¨
    â””â”€â”€ docker-compose.yml
```

## âš¡ ABSOLUTE MUST-DO RULES

### 1. SECURITY FIRST
- **NEVER** store secrets in code - use environment variables ONLY
- **ALWAYS** use read-only database connections for external data sources
- **MANDATORY** SQL injection prevention on ALL queries
- **REQUIRED** input validation on ALL user inputs
- **ESSENTIAL** JWT token validation on protected endpoints

### 2. CODE ORGANIZATION
- **MUST** follow the exact directory structure above
- **REQUIRED** separate concerns: NLP â†’ Query â†’ Visualization â†’ Response
- **MANDATORY** use dependency injection for all services
- **ESSENTIAL** implement proper error handling with structured logging

### 3. DATA HANDLING
- **CRITICAL** implement personal data masking automatically
- **REQUIRED** cache frequently used queries in Redis
- **MANDATORY** limit query execution time (30 seconds max)
- **ESSENTIAL** validate file uploads (type, size, content)

## ğŸš« ABSOLUTE NEVER-DO RULES

### 1. SECURITY VIOLATIONS
- **NEVER** allow DDL operations (CREATE, DROP, ALTER) from user queries
- **NEVER** execute dynamic SQL without parameterization
- **NEVER** store passwords in plain text
- **NEVER** expose internal error details to users
- **NEVER** trust user input without validation

### 2. PERFORMANCE KILLERS
- **NEVER** load entire large datasets into memory at once
- **NEVER** make synchronous API calls without timeouts
- **NEVER** forget to implement connection pooling
- **NEVER** skip caching for expensive operations
- **NEVER** allow unbounded result sets

### 3. CODE QUALITY ISSUES
- **NEVER** mix business logic with presentation layer
- **NEVER** hardcode configuration values
- **NEVER** ignore exception handling
- **NEVER** skip input sanitization
- **NEVER** commit commented-out code

## ğŸ”„ WORKFLOW PATTERNS

### Request Processing Flow (Clean Architecture ê¸°ë°˜)
```
User Input â†’ API Layer (FastAPI) â†’ Use Case Layer â†’ Domain Layer
     â†“                                    â†“              â†“
HTTP Request â†’ AnalysisRequest â†’ ExecuteAnalysisUseCase â†’ AnalysisQuery Entity
     â†“                                    â†“              â†“
Validation â†’ Pydantic Schema â†’ Business Logic â†’ Domain Rules
     â†“                                    â†“              â†“
Route Decision â†’ Analysis Engine Interface â†’ Repository Interface
     â†“                                    â†“              â†“
[DB Query Path]           [Excel Analysis Path]    Infrastructure Layer
     â†“                         â†“                         â†“
SQL Generation           Code Generation          Adapter Implementation
     â†“                         â†“                         â†“
Query Execution         Safe Execution           External Services
     â†“                         â†“                         â†“
     â””â”€â”€â”€â”€â†’ Visualization â†â”€â”€â”€â”€â”˜                Infrastructure
             â†“                                        â†“
         Response Generation â† AnalysisResult â† Value Object
             â†“
         HTTP Response
```

### Error Handling Strategy
- **Log everything** with structured logging (structlog)
- **Return user-friendly** error messages
- **Implement retry logic** for transient failures
- **Graceful degradation** when services are unavailable

## ğŸ“Š NAMING CONVENTIONS

### Files and Directories
- Use snake_case for Python files: `nlp_processor.py`
- Use kebab-case for configuration files: `docker-compose.yml`
- Descriptive names that explain purpose: `query_result_cache.py`

### Code Elements
- Classes: PascalCase â†’ `DataAnalysisEngine`
- Functions: snake_case â†’ `analyze_natural_language_query`
- Variables: snake_case â†’ `user_question_text`
- Constants: UPPER_SNAKE_CASE â†’ `MAX_QUERY_EXECUTION_TIME`

## ğŸ¯ KEY SUCCESS METRICS
- Response time < 10 seconds for simple queries
- Response time < 30 seconds for complex analysis
- 99% uptime during business hours
- Zero security vulnerabilities
- 90%+ query success rate

## ğŸ“Š í˜„ì¬ í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©

### âœ… ì™„ë£Œëœ Phase
- **Phase 1**: í”„ë¡œì íŠ¸ ì´ˆê¸° ì„¤ì • (100% ì™„ë£Œ)
- **Phase 2**: ë°±ì—”ë“œ ê¸°ë³¸ êµ¬ì¡° (100% ì™„ë£Œ)
- **Phase 2.5**: Clean Architecture êµ¬í˜„ (100% ì™„ë£Œ)

### ğŸ”„ ë‹¤ìŒ ë‹¨ê³„ (Phase 3: í•µì‹¬ ë¶„ì„ ì—”ì§„)
1. **OpenAI LLM í†µí•©** - GPT-4 API ì—°ë™
2. **ìì—°ì–´ ì²˜ë¦¬ ëª¨ë“ˆ** - ì§ˆë¬¸ ë¶„ì„ ë° ë¶„ë¥˜
3. **SQL ìƒì„± ì—”ì§„** - LangChain SQL Agent
4. **Excel ë¶„ì„ ì—”ì§„** - Pandas ê¸°ë°˜ ë¶„ì„
5. **ì‹œê°í™” ì—”ì§„** - Plotly ì°¨íŠ¸ ìƒì„±

### ğŸ—ï¸ êµ¬í˜„ëœ Clean Architecture ì»´í¬ë„ŒíŠ¸
- âœ… **Domain Layer**: ì—”í‹°í‹°, ê°’ ê°ì²´, ì¸í„°í˜ì´ìŠ¤
- âœ… **Use Cases Layer**: ExecuteAnalysisUseCase
- âœ… **Infrastructure Layer**: DI ì»¨í…Œì´ë„ˆ, Mock ì–´ëŒ‘í„°
- âœ… **API Layer**: ë¶„ì„ ì—”ë“œí¬ì¸íŠ¸, ìŠ¤í‚¤ë§ˆ ê²€ì¦

Remember: This is a production system handling sensitive data. Every decision must prioritize security, performance, and user experience. Clean Architecture ì›ì¹™ì„ ì¤€ìˆ˜í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥í•˜ê³  í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.