---
globs: tests/**/*.py,app/**/*test*.py
description: DataGenie ì „ìš© í…ŒìŠ¤íŠ¸ ì „ëµ ë° TDD êµ¬í˜„ ê°€ì´ë“œ
---

# DataGenie í…ŒìŠ¤íŠ¸ ì „ëµ ë° TDD ê·œì¹™

## ğŸ§ª DataGenie TDD ì»¨í…ìŠ¤íŠ¸

DataGenieëŠ” **Clean Architecture**ì™€ **TDD**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°œë°œë©ë‹ˆë‹¤. ëª¨ë“  í”„ë¡œë•ì…˜ ì½”ë“œëŠ” **ë°˜ë“œì‹œ** ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ë¨¼ì € ì‘ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

## âš¡ DataGenie TDD í•„ìˆ˜ íŒ¨í„´

### 1. Domain Layer í…ŒìŠ¤íŠ¸ (ê°€ì¥ ì¤‘ìš”)
```python
# âœ… REQUIRED: Domain ì—”í‹°í‹° í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
import pytest
from datetime import datetime
from app.domain.entities.analysis_query import AnalysisQuery, QueryType, QueryStatus

class TestAnalysisQuery:
    """AnalysisQuery ë„ë©”ì¸ ì—”í‹°í‹° í…ŒìŠ¤íŠ¸"""
    
    def test_create_valid_analysis_query(self):
        """RED â†’ GREEN: ìœ íš¨í•œ ë¶„ì„ ì¿¼ë¦¬ ìƒì„±"""
        # Arrange
        query = AnalysisQuery.create(
            question="ì§€ë‚œ 3ê°œì›” ë§¤ì¶œ ì¶”ì´ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”",
            user_id="user-123",
            query_type="database"
        )
        
        # Act & Assert
        assert query.is_valid() == True
        assert query.question == "ì§€ë‚œ 3ê°œì›” ë§¤ì¶œ ì¶”ì´ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”"
        assert query.query_type == QueryType.DATABASE
        assert query.status == QueryStatus.PENDING
        assert query.can_be_executed_by("user-123") == True
    
    def test_invalid_query_empty_question(self):
        """RED â†’ GREEN: ë¹ˆ ì§ˆë¬¸ ê²€ì¦"""
        # Arrange & Act
        query = AnalysisQuery.create(
            question="",
            user_id="user-123", 
            query_type="database"
        )
        
        # Assert
        assert query.is_valid() == False
    
    def test_invalid_query_too_long(self):
        """RED â†’ GREEN: ë„ˆë¬´ ê¸´ ì§ˆë¬¸ ê²€ì¦"""
        # Arrange
        long_question = "A" * 1001  # 1000ì ì´ˆê³¼
        
        # Act
        query = AnalysisQuery.create(
            question=long_question,
            user_id="user-123",
            query_type="database"
        )
        
        # Assert
        assert query.is_valid() == False
    
    @pytest.mark.parametrize("user_id,expected", [
        ("user-123", True),   # ê°™ì€ ì‚¬ìš©ì
        ("user-456", False),  # ë‹¤ë¥¸ ì‚¬ìš©ì
    ])
    def test_execution_permission(self, user_id, expected):
        """RED â†’ GREEN: ì‹¤í–‰ ê¶Œí•œ ê²€ì¦"""
        # Arrange
        query = AnalysisQuery.create(
            question="í…ŒìŠ¤íŠ¸ ì§ˆë¬¸",
            user_id="user-123",
            query_type="database"
        )
        
        # Act & Assert
        assert query.can_be_executed_by(user_id) == expected
```

### 2. Use Case Layer í…ŒìŠ¤íŠ¸
```python
# âœ… REQUIRED: Use Case í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
import pytest
from unittest.mock import Mock, AsyncMock
from app.use_cases.analysis.execute_analysis_use_case import (
    ExecuteAnalysisUseCase,
    AnalysisRequest,
    PermissionDeniedError,
    InvalidQueryError
)

class TestExecuteAnalysisUseCase:
    """ExecuteAnalysisUseCase í…ŒìŠ¤íŠ¸"""
    
    @pytest.fixture
    def mock_dependencies(self):
        """ì˜ì¡´ì„± Mock ì„¤ì •"""
        return {
            "query_repository": AsyncMock(),
            "analysis_engine": AsyncMock(),
            "user_permissions": AsyncMock()
        }
    
    @pytest.fixture
    def use_case(self, mock_dependencies):
        """í…ŒìŠ¤íŠ¸ ëŒ€ìƒ Use Case"""
        return ExecuteAnalysisUseCase(**mock_dependencies)
    
    @pytest.mark.asyncio
    async def test_successful_analysis_execution(self, use_case, mock_dependencies):
        """RED â†’ GREEN: ì„±ê³µì ì¸ ë¶„ì„ ì‹¤í–‰"""
        # Arrange
        request = AnalysisRequest(
            question="ë§¤ì¶œ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”",
            user_id="user-123",
            query_type="database"
        )
        
        # Mock ì„¤ì •
        mock_dependencies["user_permissions"].can_execute_analysis.return_value = True
        mock_dependencies["analysis_engine"].execute_analysis.return_value = Mock(
            success=True,
            data={"result": "mock_data"}
        )
        
        # Act
        result = await use_case.execute(request, "user-123")
        
        # Assert
        assert result.success == True
        mock_dependencies["user_permissions"].can_execute_analysis.assert_called_once_with("user-123")
        mock_dependencies["query_repository"].save.assert_called_once()
    
    @pytest.mark.asyncio
    async def test_permission_denied_error(self, use_case, mock_dependencies):
        """RED â†’ GREEN: ê¶Œí•œ ê±°ë¶€ ì—ëŸ¬"""
        # Arrange
        request = AnalysisRequest(
            question="ë§¤ì¶œ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”",
            user_id="user-123",
            query_type="database"
        )
        
        # Mock ì„¤ì • - ê¶Œí•œ ì—†ìŒ
        mock_dependencies["user_permissions"].can_execute_analysis.return_value = False
        
        # Act & Assert
        with pytest.raises(PermissionDeniedError, match="ë¶„ì„ ì‹¤í–‰ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"):
            await use_case.execute(request, "user-123")
        
        # Repository í˜¸ì¶œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
        mock_dependencies["query_repository"].save.assert_not_called()
    
    @pytest.mark.asyncio
    async def test_invalid_query_error(self, use_case, mock_dependencies):
        """RED â†’ GREEN: ìœ íš¨í•˜ì§€ ì•Šì€ ì¿¼ë¦¬ ì—ëŸ¬"""
        # Arrange
        request = AnalysisRequest(
            question="",  # ë¹ˆ ì§ˆë¬¸
            user_id="user-123",
            query_type="database"
        )
        
        # Mock ì„¤ì •
        mock_dependencies["user_permissions"].can_execute_analysis.return_value = True
        
        # Act & Assert
        with pytest.raises(InvalidQueryError, match="ìœ íš¨í•˜ì§€ ì•Šì€ ì§ˆë¬¸ì…ë‹ˆë‹¤"):
            await use_case.execute(request, "user-123")
```

### 3. API Layer í…ŒìŠ¤íŠ¸
```python
# âœ… REQUIRED: API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
import pytest
from fastapi.testclient import TestClient
from unittest.mock import AsyncMock, patch
from app.main import app

class TestAnalysisAPI:
    """ë¶„ì„ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸"""
    
    @pytest.fixture
    def client(self):
        """í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸"""
        return TestClient(app)
    
    @pytest.fixture
    def mock_use_case(self):
        """Use Case Mock"""
        return AsyncMock()
    
    def test_execute_analysis_success(self, client, mock_use_case):
        """RED â†’ GREEN: ë¶„ì„ ì‹¤í–‰ ì„±ê³µ"""
        # Arrange
        request_data = {
            "question": "ì§€ë‚œ ë‹¬ ë§¤ì¶œì„ ë³´ì—¬ì£¼ì„¸ìš”",
            "connection_id": "conn-123",
            "options": {"auto_visualize": True}
        }
        
        mock_result = Mock(
            success=True,
            data={"sql": "SELECT * FROM sales", "result": []}
        )
        mock_use_case.execute.return_value = mock_result
        
        # Mock ì˜ì¡´ì„± ì£¼ì…
        with patch('app.api.dependencies.get_execute_analysis_use_case', return_value=mock_use_case), \
             patch('app.api.dependencies.get_current_user', return_value={"id": "user-123"}):
            
            # Act
            response = client.post(
                "/api/v1/analysis/execute",
                json=request_data,
                headers={"Authorization": "Bearer dummy-token"}
            )
        
        # Assert
        assert response.status_code == 200
        response_data = response.json()
        assert response_data["success"] == True
        assert "data" in response_data
    
    def test_execute_analysis_unauthorized(self, client):
        """RED â†’ GREEN: ì¸ì¦ë˜ì§€ ì•Šì€ ìš”ì²­"""
        # Arrange
        request_data = {
            "question": "ë§¤ì¶œ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”"
        }
        
        # Act - Authorization í—¤ë” ì—†ì´ ìš”ì²­
        response = client.post("/api/v1/analysis/execute", json=request_data)
        
        # Assert
        assert response.status_code == 403  # Forbidden
    
    def test_execute_analysis_invalid_request(self, client):
        """RED â†’ GREEN: ìœ íš¨í•˜ì§€ ì•Šì€ ìš”ì²­"""
        # Arrange
        invalid_request = {
            "question": "",  # ë¹ˆ ì§ˆë¬¸
        }
        
        with patch('app.api.dependencies.get_current_user', return_value={"id": "user-123"}):
            # Act
            response = client.post(
                "/api/v1/analysis/execute",
                json=invalid_request,
                headers={"Authorization": "Bearer dummy-token"}
            )
        
        # Assert
        assert response.status_code == 422  # Validation Error
```

### 4. Infrastructure Layer í…ŒìŠ¤íŠ¸
```python
# âœ… REQUIRED: Repository êµ¬í˜„ì²´ í…ŒìŠ¤íŠ¸
import pytest
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
from app.infrastructure.adapters.repositories.sqlalchemy_query_repository import SqlAlchemyQueryRepository
from app.domain.entities.analysis_query import AnalysisQuery
from app.models.base import Base

class TestSqlAlchemyQueryRepository:
    """SQLAlchemy Repository êµ¬í˜„ì²´ í…ŒìŠ¤íŠ¸"""
    
    @pytest.fixture
    async def test_db_session(self):
        """í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜"""
        # ë©”ëª¨ë¦¬ SQLite ì‚¬ìš©
        engine = create_async_engine("sqlite+aiosqlite:///:memory:")
        
        # í…Œì´ë¸” ìƒì„±
        async with engine.begin() as conn:
            await conn.run_sync(Base.metadata.create_all)
        
        # ì„¸ì…˜ ìƒì„±
        async_session = async_sessionmaker(engine)
        async with async_session() as session:
            yield session
        
        await engine.dispose()
    
    @pytest.mark.asyncio
    async def test_save_and_find_query(self, test_db_session):
        """RED â†’ GREEN: ì¿¼ë¦¬ ì €ì¥ ë° ì¡°íšŒ"""
        # Arrange
        repository = SqlAlchemyQueryRepository(test_db_session)
        query = AnalysisQuery.create(
            question="í…ŒìŠ¤íŠ¸ ì§ˆë¬¸",
            user_id="user-123",
            query_type="database"
        )
        
        # Act
        await repository.save(query)
        found_query = await repository.find_by_id(query.id)
        
        # Assert
        assert found_query is not None
        assert found_query.id == query.id
        assert found_query.question == "í…ŒìŠ¤íŠ¸ ì§ˆë¬¸"
        assert found_query.user_id == "user-123"
    
    @pytest.mark.asyncio
    async def test_find_by_user_id(self, test_db_session):
        """RED â†’ GREEN: ì‚¬ìš©ìë³„ ì¿¼ë¦¬ ì¡°íšŒ"""
        # Arrange
        repository = SqlAlchemyQueryRepository(test_db_session)
        
        # ì—¬ëŸ¬ ì¿¼ë¦¬ ì €ì¥
        query1 = AnalysisQuery.create("ì§ˆë¬¸1", "user-123", "database")
        query2 = AnalysisQuery.create("ì§ˆë¬¸2", "user-123", "excel")
        query3 = AnalysisQuery.create("ì§ˆë¬¸3", "user-456", "database")
        
        await repository.save(query1)
        await repository.save(query2)
        await repository.save(query3)
        
        # Act
        user_queries = await repository.find_by_user_id("user-123")
        
        # Assert
        assert len(user_queries) == 2
        assert all(q.user_id == "user-123" for q in user_queries)
```

## ğŸ§ª DataGenie ì „ìš© í…ŒìŠ¤íŠ¸ ìœ í‹¸ë¦¬í‹°

### 1. í…ŒìŠ¤íŠ¸ í”½ìŠ¤ì²˜
```python
# âœ… REQUIRED: DataGenie ê³µí†µ í…ŒìŠ¤íŠ¸ í”½ìŠ¤ì²˜
import pytest
from datetime import datetime
from app.domain.entities.analysis_query import AnalysisQuery

@pytest.fixture
def sample_analysis_query():
    """ìƒ˜í”Œ ë¶„ì„ ì¿¼ë¦¬"""
    return AnalysisQuery.create(
        question="ì§€ë‚œ ë‹¬ ë§¤ì¶œ ì¶”ì´ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”",
        user_id="test-user-123",
        query_type="database"
    )

@pytest.fixture
def sample_analysis_request():
    """ìƒ˜í”Œ ë¶„ì„ ìš”ì²­"""
    from app.use_cases.analysis.execute_analysis_use_case import AnalysisRequest
    return AnalysisRequest(
        question="ë§¤ì¶œ ë°ì´í„° ë¶„ì„",
        user_id="test-user-123",
        query_type="database",
        connection_id="test-conn-123"
    )

@pytest.fixture
def mock_analysis_result():
    """Mock ë¶„ì„ ê²°ê³¼"""
    from app.domain.value_objects.analysis_result import AnalysisResult
    return AnalysisResult(
        analysis_type="database",
        question="í…ŒìŠ¤íŠ¸ ì§ˆë¬¸",
        sql_query="SELECT * FROM test_table",
        data=[{"id": 1, "name": "test"}],
        columns=["id", "name"],
        row_count=1,
        summary="í…ŒìŠ¤íŠ¸ ê²°ê³¼ì…ë‹ˆë‹¤"
    )
```

### 2. í…ŒìŠ¤íŠ¸ í—¬í¼
```python
# âœ… REQUIRED: DataGenie í…ŒìŠ¤íŠ¸ í—¬í¼ í•¨ìˆ˜
class DataGenieTestHelpers:
    """DataGenie ì „ìš© í…ŒìŠ¤íŠ¸ í—¬í¼"""
    
    @staticmethod
    def create_test_user(user_id: str = "test-user") -> dict:
        """í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ìƒì„±"""
        return {
            "id": user_id,
            "username": f"{user_id}_name",
            "email": f"{user_id}@test.com",
            "is_active": True
        }
    
    @staticmethod
    def create_test_schema() -> dict:
        """í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ"""
        return {
            "users": {
                "columns": [
                    {"name": "id", "type": "integer", "primary_key": True},
                    {"name": "name", "type": "varchar"},
                    {"name": "email", "type": "varchar"}
                ]
            },
            "orders": {
                "columns": [
                    {"name": "id", "type": "integer", "primary_key": True},
                    {"name": "user_id", "type": "integer", "foreign_key": "users.id"},
                    {"name": "amount", "type": "decimal"},
                    {"name": "created_at", "type": "timestamp"}
                ]
            }
        }
    
    @staticmethod
    def assert_valid_analysis_result(result):
        """ë¶„ì„ ê²°ê³¼ ìœ íš¨ì„± ê²€ì¦"""
        assert hasattr(result, 'success')
        assert hasattr(result, 'data')
        if result.success:
            assert result.data is not None
```

## ğŸš« DataGenie í…ŒìŠ¤íŠ¸ ì•ˆí‹°íŒ¨í„´

### 1. ê¸ˆì§€ëœ í…ŒìŠ¤íŠ¸ íŒ¨í„´
```python
# ğŸš« FORBIDDEN: êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ í…ŒìŠ¤íŠ¸
def test_internal_method_calls():
    """BAD: ë‚´ë¶€ ë©”ì„œë“œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸"""
    service = AnalysisService()
    with patch.object(service, '_internal_helper') as mock:
        service.analyze("question")
        mock.assert_called_once()  # êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ í…ŒìŠ¤íŠ¸!

# ğŸš« FORBIDDEN: í…ŒìŠ¤íŠ¸ í›„ ì½”ë“œ ì‘ì„±
def test_existing_functionality():
    """BAD: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸"""
    result = existing_function()
    assert result == "current_output"  # ì˜ë¯¸ ì—†ëŠ” í…ŒìŠ¤íŠ¸!

# ğŸš« FORBIDDEN: ê³¼ë„í•œ Mock ì‚¬ìš©
def test_with_too_many_mocks():
    """BAD: ë„ˆë¬´ ë§ì€ Mockìœ¼ë¡œ ì˜ë¯¸ ì—†ëŠ” í…ŒìŠ¤íŠ¸"""
    with patch('module.A') as mock_a, \
         patch('module.B') as mock_b, \
         patch('module.C') as mock_c:
        result = service.do_something()
        assert result == mock_a.return_value  # ì˜ë¯¸ ì—†ìŒ
```

## ğŸ“‹ DataGenie TDD ì²´í¬ë¦¬ìŠ¤íŠ¸

### Red Phase (ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸)
- [ ] âœ… í”„ë¡œë•ì…˜ ì½”ë“œ ì‘ì„± ì „ í…ŒìŠ¤íŠ¸ ì‘ì„±
- [ ] âœ… ì˜¬ë°”ë¥¸ ì´ìœ ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
- [ ] âœ… ëª…í™•í•œ ë™ì‘ ì„¤ëª…
- [ ] âœ… ìµœì†Œí•œì´ê³  ì§‘ì¤‘ëœ í…ŒìŠ¤íŠ¸
- [ ] âœ… ì˜ˆìƒëŒ€ë¡œ ì‹¤í–‰ë˜ê³  ì‹¤íŒ¨

### Green Phase (í†µê³¼ ì½”ë“œ)
- [ ] âœ… í…ŒìŠ¤íŠ¸ í†µê³¼ë¥¼ ìœ„í•œ ìµœì†Œ ì½”ë“œ
- [ ] âœ… ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„ ì•ˆ í•¨
- [ ] âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] âœ… ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ë™ì‘
- [ ] âœ… í…ŒìŠ¤íŠ¸ë¥¼ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë§Œë“œëŠ” ë° ì§‘ì¤‘

### Refactor Phase (ë¦¬íŒ©í„°ë§)
- [ ] âœ… ì½”ë“œ êµ¬ì¡° ê°œì„ 
- [ ] âœ… ì¤‘ë³µ ì œê±°
- [ ] âœ… ì´ë¦„ ëª…í™•í™”
- [ ] âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì—¬ì „íˆ í†µê³¼
- [ ] âœ… ë™ì‘ ë³€ê²½ ì—†ìŒ

## ğŸ¯ DataGenie í…ŒìŠ¤íŠ¸ í’ˆì§ˆ ëª©í‘œ

### ì»¤ë²„ë¦¬ì§€ ëª©í‘œ
- **Domain Layer**: 100% ë¼ì¸ ì»¤ë²„ë¦¬ì§€
- **Use Cases Layer**: 100% ë¼ì¸ ì»¤ë²„ë¦¬ì§€
- **API Layer**: 95% ë¼ì¸ ì»¤ë²„ë¦¬ì§€
- **Infrastructure Layer**: 90% ë¼ì¸ ì»¤ë²„ë¦¬ì§€

### ì„±ëŠ¥ ëª©í‘œ
- **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: < 1ì´ˆ ê°ê°
- **í†µí•© í…ŒìŠ¤íŠ¸**: < 5ì´ˆ ê°ê°
- **ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸**: < 30ì´ˆ

### í’ˆì§ˆ ë©”íŠ¸ë¦­
- **í…ŒìŠ¤íŠ¸ ëŒ€ ì½”ë“œ ë¹„ìœ¨**: 2:1 ì´ìƒ
- **ì–´ì„¤ì…˜ ë°€ë„**: í…ŒìŠ¤íŠ¸ë‹¹ 3-5ê°œ ì–´ì„¤ì…˜
- **Mock ì‚¬ìš©ë¥ **: í…ŒìŠ¤íŠ¸ì˜ 30% ë¯¸ë§Œ

Remember: **TDDëŠ” í…ŒìŠ¤íŠ¸ê°€ ì•„ë‹Œ ì„¤ê³„ì— ê´€í•œ ê²ƒì…ë‹ˆë‹¤.** í…ŒìŠ¤íŠ¸ê°€ ì–´ë µë‹¤ë©´ ì„¤ê³„ê°€ ì˜ëª»ëœ ê²ƒì…ë‹ˆë‹¤. TDDëŠ” ì²˜ìŒë¶€í„° í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ê³ , ë¶„ë¦¬ë˜ê³ , ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ë„ë¡ ê°•ì œí•©ë‹ˆë‹¤.